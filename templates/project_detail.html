<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - SynergySphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        body {
            background: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .container-main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .project-header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tabs-container {
            background: white;
            border-radius: 10px;
            padding: 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e5e7eb;
        }
        
        .nav-tabs .nav-link {
            color: #6b7280;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }
        
        .tab-content {
            padding: 2rem;
        }
        
        .task-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .task-column {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1rem;
            min-height: 400px;
        }
        
        .task-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .task-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .message {
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .message.own-message {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            max-width: 70%;
        }
        
        .member-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .btn-primary-custom:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-hexagon-fill text-primary"></i> SynergySphere
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/projects">Projects</a>
                <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Project Header -->
        <div class="project-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 id="projectName">Loading...</h2>
                    <p class="text-muted mb-0" id="projectDescription">Loading description...</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="editProject()">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteProject()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tasksTab">
                        <i class="bi bi-list-task"></i> Tasks
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#messagesTab">
                        <i class="bi bi-chat-dots"></i> Messages
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#membersTab">
                        <i class="bi bi-people"></i> Members
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Tasks Tab -->
                <div class="tab-pane fade show active" id="tasksTab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Tasks</h4>
                        <button class="btn btn-primary-custom" onclick="showCreateTaskModal()">
                            <i class="bi bi-plus"></i> Add Task
                        </button>
                    </div>
                    <div class="task-board">
                        <div class="task-column">
                            <h5>To Do</h5>
                            <div id="todoTasks" class="task-list" data-status="todo"></div>
                        </div>
                        <div class="task-column">
                            <h5>In Progress</h5>
                            <div id="inProgressTasks" class="task-list" data-status="in_progress"></div>
                        </div>
                        <div class="task-column">
                            <h5>Done</h5>
                            <div id="doneTasks" class="task-list" data-status="done"></div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div class="tab-pane fade" id="messagesTab">
                    <div class="message-container">
                        <h4>Project Discussion</h4>
                        <div class="messages-list" id="messagesList"></div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                            <button class="btn btn-primary-custom" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div class="tab-pane fade" id="membersTab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Team Members</h4>
                        <button class="btn btn-primary-custom" onclick="showAddMemberModal()">
                            <i class="bi bi-person-plus"></i> Add Member
                        </button>
                    </div>
                    <div id="membersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal fade" id="createTaskModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="taskPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="taskDueDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="createTask()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Team Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="memberEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="memberRole">
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="addMember()">Add Member</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const projectId = new URLSearchParams(window.location.search).get('id') || window.location.pathname.split('/').pop();
        const token = localStorage.getItem('token');
        let currentProject = null;
        let projectTasks = [];
        let projectMessages = [];
        let projectMembers = [];

        if (!token) {
            window.location.href = '/login';
        }

        // Load project details on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProject();
            loadTasks();
            loadMessages();
            loadMembers();
        });

        async function apiRequest(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }

            return response.json();
        }

        async function loadProject() {
            try {
                currentProject = await apiRequest(`/api/projects/${projectId}`);
                document.getElementById('projectName').textContent = currentProject.name;
                document.getElementById('projectDescription').textContent = currentProject.description || 'No description';
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project');
            }
        }

        async function loadTasks() {
            try {
                const response = await apiRequest(`/api/projects/${projectId}/tasks`);
                projectTasks = response.tasks || [];
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function renderTasks() {
            const todoContainer = document.getElementById('todoTasks');
            const inProgressContainer = document.getElementById('inProgressTasks');
            const doneContainer = document.getElementById('doneTasks');

            // Clear containers
            todoContainer.innerHTML = '';
            inProgressContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            // Group tasks by status
            projectTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                
                if (task.status === 'todo') {
                    todoContainer.appendChild(taskCard);
                } else if (task.status === 'in_progress') {
                    inProgressContainer.appendChild(taskCard);
                } else if (task.status === 'done') {
                    doneContainer.appendChild(taskCard);
                }
            });

            // Setup drag and drop
            setupDragAndDrop();
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.taskId = task.id;
            
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${task.title}</h6>
                        <p class="text-muted small mb-1">${task.description || ''}</p>
                        ${task.due_date ? `<small class="text-warning"><i class="bi bi-calendar"></i> ${new Date(task.due_date).toLocaleDateString()}</small>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function setupDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const taskLists = document.querySelectorAll('.task-list');

            taskCards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('taskId', card.dataset.taskId);
                    card.style.opacity = '0.5';
                });

                card.addEventListener('dragend', () => {
                    card.style.opacity = '1';
                });
            });

            taskLists.forEach(list => {
                list.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    list.style.backgroundColor = '#e5e7eb';
                });

                list.addEventListener('dragleave', () => {
                    list.style.backgroundColor = '';
                });

                list.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    list.style.backgroundColor = '';
                    
                    const taskId = e.dataTransfer.getData('taskId');
                    const newStatus = list.dataset.status;
                    
                    try {
                        await apiRequest(`/api/tasks/${taskId}`, {
                            method: 'PATCH',
                            body: JSON.stringify({ status: newStatus })
                        });
                        loadTasks();
                    } catch (error) {
                        console.error('Error updating task:', error);
                        alert('Failed to update task status');
                    }
                });
            });
        }

        async function loadMessages() {
            try {
                const response = await apiRequest(`/api/projects/${projectId}/messages`);
                projectMessages = response.messages || [];
                renderMessages();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesList');
            
            if (projectMessages.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No messages yet. Start the conversation!</p>';
                return;
            }

            container.innerHTML = projectMessages.map(msg => `
                <div class="message ${msg.user_id === JSON.parse(localStorage.getItem('user')).id ? 'own-message' : ''}">
                    <small class="d-block mb-1"><strong>${msg.user_name}</strong> • ${new Date(msg.created_at).toLocaleString()}</small>
                    <div>${msg.content}</div>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;

            try {
                await apiRequest(`/api/projects/${projectId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });
                input.value = '';
                loadMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        async function loadMembers() {
            try {
                const response = await apiRequest(`/api/projects/${projectId}/members`);
                projectMembers = response.members || [];
                renderMembers();
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        function renderMembers() {
            const container = document.getElementById('membersList');
            
            if (projectMembers.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No members yet.</p>';
                return;
            }

            container.innerHTML = projectMembers.map(member => `
                <div class="member-card">
                    <div class="member-info">
                        <div class="member-avatar">${member.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="fw-medium">${member.name}</div>
                            <div class="text-muted small">${member.email}</div>
                        </div>
                    </div>
                    <div>
                        <span class="badge bg-${member.is_owner ? 'primary' : 'secondary'}">${member.role}</span>
                        ${!member.is_owner ? `
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeMember(${member.id})">
                                <i class="bi bi-x"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showCreateTaskModal() {
            const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
            modal.show();
        }

        async function createTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;

            if (!title) {
                alert('Title is required');
                return;
            }

            try {
                await apiRequest(`/api/projects/${projectId}/tasks`, {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        description,
                        priority,
                        due_date: dueDate || null,
                        status: 'todo'
                    })
                });
                
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                document.getElementById('createTaskForm').reset();
                loadTasks();
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Failed to create task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                await apiRequest(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                loadTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task');
            }
        }

        function showAddMemberModal() {
            const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
            modal.show();
        }

        async function addMember() {
            const email = document.getElementById('memberEmail').value;
            const role = document.getElementById('memberRole').value;

            if (!email) {
                alert('Email is required');
                return;
            }

            try {
                await apiRequest(`/api/projects/${projectId}/members`, {
                    method: 'POST',
                    body: JSON.stringify({ email, role })
                });
                
                bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                document.getElementById('addMemberForm').reset();
                loadMembers();
            } catch (error) {
                console.error('Error adding member:', error);
                alert(error.message || 'Failed to add member');
            }
        }

        async function removeMember(memberId) {
            if (!confirm('Are you sure you want to remove this member?')) return;

            try {
                await apiRequest(`/api/projects/${projectId}/members/${memberId}`, {
                    method: 'DELETE'
                });
                loadMembers();
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Failed to remove member');
            }
        }

        async function deleteProject() {
            if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;

            try {
                await apiRequest(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });
                window.location.href = '/dashboard';
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Auto-refresh messages every 10 seconds
        setInterval(loadMessages, 10000);
    </script>
</body>
</html>
